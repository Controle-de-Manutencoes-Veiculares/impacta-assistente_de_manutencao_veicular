{% extends 'layouts/layout.html' %} 
{% block title %} Principal{% endblock %} 
{% block content %}
<h1 class="titulo">Área do Cliente</h1>

<section>
  <div>
    <!-- icone carro ? -->
    <h2>Meus Carros</h2>
    <button
      type="button"
      class="btn btn-primary"
      data-bs-toggle="modal"
      data-bs-target="#modalAddCar"
    >
      Adicionar Carro
    </button>

    <div
      class="modal fade"
      id="modalAddCar"
      tabindex="-1"
      aria-labelledby="exampleModalLabel"
      aria-hidden="true"
    >
      <!-- Conteúdo da modal aqui -->
    </div>

    <hr />
    <table class="table table-striped">
      <thead>
        <tr>
          <th scope="col">Placa</th>
          <th scope="col">Cor</th>
          <th scope="col">Marca</th>
          <th scope="col">Modelo</th>
          <th scope="col">Ano</th>
          <th scope="col">KM</th>
          <th scope="col">Ações</th> <!-- Coluna para botões de ação -->
        </tr>
      </thead>
      <tbody>
        {% for carro in veiculos %}
        <tr>
          <td>{{ carro["placa"] }}</td>
          <td>{{ carro["cor"] }}</td>
          <td>{{ carro["marca"] }}</td>
          <td>{{ carro["modelo"] }}</td>
          <td>{{ carro["ano"] }}</td>
          <td>{{ carro["km"] }}</td>
          <td>
            <!-- Botão de edição -->
            <button
              class="btn btn-primary edit-carro-btn" data-id="{{ carro.id_veiculo }}" data-bs-toggle="modal" data-bs-target="#modalAddCar">Editar</button>
            <!-- Botão de exclusão -->
            <button class="btn btn-danger delete-carro-btn" data-id="{{ carro.id_veiculo }}">Excluir</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div>
    <!-- icone alerta ?-->
    <!-- <h2>Alertas</h2>
        <hr> -->
    <!-- fazer lista de alertas de manutenção
                {for alerta in alertas}
                {endfor} 
        -->
  </div>
  <div>
    <!-- icone config ?-->
    <!-- <h2>Configurações</h2>
            <hr> -->
    <!-- fazer menu de configuracoes -->
  </div>
  <!-- Modal de Confirmação -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" role="dialog" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmação de Exclusão</h5>
            </div>
            <div class="modal-body">
            Tem certeza de que deseja excluir este veículo?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Close">Cancelar</button>
            <button type="button" class="btn btn-primary" id="confirmDeleteBtn">Confirmar</button>
            </div>
        </div>
        </div>
    </div>
  <!-- Alerta do Bootstrap -->
</section>

<script>
    function enviarFormulario() {
        var formulario = document.getElementById((id = "carroForm"));
        var formData = new FormData(formulario);
        var objeto = {};
        formData.forEach(function (value, key) {
        objeto[key] = value;
        });
        var json = JSON.stringify(objeto);
        // Agora você pode enviar o JSON usando fetch() ou outra biblioteca de sua escolha
        fetch("/veiculo", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
        },
        body: json,
        })
        .then((response) => {
            if (response.ok) {
            // Se a resposta for bem-sucedida (Status Code: 200), mostra o alerta de sucesso
            document.getElementById("alerta").innerHTML =
                '<div class="alert alert-success" role="alert">Veículo adicionado com sucesso!</div>';
            document.getElementById("alerta").style.display = "block";
            window.scrollTo(0, 0);
            alert('Veículo adicionado com sucesso');


            // Aguarda 5 segundos antes de redirecionar para /
            setTimeout(function () {
                window.location.href = "/";
            }, 1000);
            fetch("/", {
                method: "GET",
            });
            } else {
            // Se a resposta não for bem-sucedida, mostra um alerta de erro
            document.getElementById("alerta").innerHTML =
                '<div class="alert alert-danger" role="alert">Ocorreu um erro ao adicionar o veículo.</div>';
            document.getElementById("alerta").style.display = "block";
            }
        })
        .catch((error) => {
            // Se houver erro na requisição, mostra um alerta de erro
            document.getElementById("alerta").innerHTML =
            '<div class="alert alert-danger" role="alert">Ocorreu um erro ao adicionar o veículo.</div>';
            document.getElementById("alerta").style.display = "block";
            console.error("Erro ao adicionar veículo:", error);
        });
    }
    
    // Função para exibir a modal de confirmação
    function showConfirmDeleteModal(id) {
        $('#confirmDeleteModal').modal('show');

        // Remove todos os event listeners anteriores do botão de confirmar exclusão
        $('#confirmDeleteBtn').off('click');

        // Adiciona um novo event listener para o botão de confirmar exclusão
        $('#confirmDeleteBtn').on('click', function() {
            deleteCarro(id);
            $('#confirmDeleteModal').modal('hide'); // Fecha a modal
        });

        // Remove todos os event listeners anteriores do botão de cancelar
        $('#cancelDeleteBtn').off('click');

        // Adiciona um novo event listener para o botão de cancelar
        $('#cancelDeleteBtn').on('click', function() {
            $('#confirmDeleteModal').modal('hide'); // Fecha a modal
        });
    }

    // Função para enviar a solicitação de exclusão
    function deleteCarro(id) {
        fetch(`/veiculo/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.ok) {
                alert('Veículo removido com sucesso');
                location.reload(); // Atualiza a página
            } else {
                throw new Error('Ocorreu um erro ao excluir o veículo');
            }
        })
        .catch(error => {
            alert(error.message);
        });
    }

    // Adiciona evento de clique nos botões de exclusão
    document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll('.delete-carro-btn').forEach(item => {
            item.addEventListener('click', function(event) {
                const id_veiculo = this.getAttribute('data-id');
                showConfirmDeleteModal(id_veiculo);
            });
        });
    });
</script>
{% endblock %}
